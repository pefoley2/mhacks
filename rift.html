<!DOCTYPE html>
<html lang="en">
	<head>
		<title>MHacks Oculus Rift / LeapMotion Demo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: rgb(168, 148, 0);
				font-family:Monospace;
				font-size:13px;
				text-align:center;

				background-color: #000000;
				margin: 0px;
				overflow: hidden;
			}
			
			#info	{
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}
		</style>
	</head>
	<body>
		<div id="container"><br /><br /><br /><br /><br />Loading ...</div>
		<div id="info"></div>
		<!-- -->
		
		<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
		<script src="./lib/three.min.js"></script>
		<script src="./lib/OculusRiftEffect.js"></script>
		<script src="./lib/OculusRiftControls.js"></script>
		<script src="./lib/stats.min.js"></script>
		<script src="./lib/vr.js"></script>
		<script src="./code/primitives.js"></script>

		<script>
			

			var container, stats;
			var camera, controls, scene, renderer;
			var time = Date.now();
			var ray;
			var info;

			var cube;
			var skybox;
			var water;
			var levelMesh;
			
			var restartLevelFlag;

			var fogLevel = 10;
			
			var level = [
				'--333444333--',
				'----------2--',
				'--2----------',
				'--22-----22--',
				'---111-111---',
				'-----1P1-----'
			];

			var clock = new THREE.Clock();

			vr.load(function(error) {
				if (error) {
					alert('Plugin load failed: ' + error.toString());
				}

				init();
				logic();
				animate();
			});
			


			function init() {
				container = document.getElementById( 'container' );
				scene = new THREE.Scene();
				
				// fog effect is used for awesome fade in
				scene.fog = new THREE.Fog(0xffffff, 50, 50);
				
				camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 7000 );			
				camera.rotation.order = 'XYZ';
				
				controls = new THREE.OculusRiftControls( camera );
				scene.add( controls.getObject() );
				
				// loading code for things that can actually differ in levels
				loadLevel();
				
				// presumably, every level in this demo is going to have water, a skybox, and
				// purple highlights / yellow shadows
				water = createWaterPlane(scene);
				skybox = createSkybox(scene);
				
				var ambientLight = new THREE.AmbientLight( 0x800080 );
				scene.add( ambientLight );

				var dirLight = new THREE.DirectionalLight( 0xffffee, 2.5 );
				dirLight.position.set( 1, 1, 0.5 ).normalize();
				scene.add( dirLight );

				// other universal things: webGL renderer, Oculus Rift effect, statistics
				renderer = new THREE.WebGLRenderer();
				renderer.setClearColor( 0x000000, 1 );
				container.innerHTML = "";
				container.appendChild( renderer.domElement );
				renderer.autoClearColor = false;
				
				effect = new THREE.OculusRiftEffect( renderer );

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );
				
				// we want to window to adapt to resizes ((like when we hit F11 in Firefox))
				window.addEventListener( 'resize', onWindowResize, false );
			}
			
			function loadLevel()	{
				levelMesh = createLevelMesh(level, camera, scene);
				
				fogLevel = 50;
				
				scene.fog.near = 50;
				scene.fog.far = 50;
			}
			
			
			function restartLevel()	{
				scene.remove(levelMesh);
				
				controls.velocity.x = 0;
				controls.velocity.y = 0;
				controls.velocity.z = 0;
				controls.canJump = false;
				controls.moveBackward = false;
				controls.moveForward = false;
				controls.moveLeft = false;
				controls.moveRight = false;
				
				restartLevelFlag = false;
				
				loadLevel();
			}
			

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );
			}

			var polled;
			var vrstate = new vr.State();
			var angle = 0;
			
			function logic()	{
				if (restartLevelFlag) restartLevel();
				
				var start = (new Date).getTime();
				
				// poll VR, if it's ready
				polled = vr.pollState(vrstate);
				controls.update( angle, polled ? vrstate : null, levelMesh );
				
				// the skybox has to keep up with the camera
				skybox.position.x = camera.position.x;
				skybox.position.y = camera.position.y;
				skybox.position.z = camera.position.z;
				
				
				// the water has to update and look cool too
				water[0].offset.x += 0.005;
				water[0].offset.y += 0.005;
				
				if (fogLevel < 9000)	{
					fogLevel += 100;
					scene.fog.far = fogLevel;
				} else	{
					scene.fog.near = 100000;
					scene.fog.far = 100000;
				}
				
				// logic should be running roughly independently of rendering
				var end = (new Date).getTime();
				var delta = end - start;
				var delay = 33.33 - delta;
				setTimeout(function(){logic()}, delay);
			}
			
			function animate() {
				vr.requestAnimationFrame( animate );
				
				angle = effect.render( scene, camera, polled ? vrstate : null, angle );
				
				stats.update();
			}

		</script>

	</body>
</html>
