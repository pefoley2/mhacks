<!DOCTYPE html>
<html lang="en">
	<head>
		<title>MHacks Oculus Rift / LeapMotion Demo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background-color: #000000;
				color: #dddddd;
				font-family: Verdana;
				font-size:13px;
				text-align:center;
				
				
				margin: 0px;
				overflow: hidden;
			}
			
			#info	{
				position: absolute;
				top: 0px;
				width: 100%;
				padding: 5px;
				color: rgb(255, 255, 255);
			}
		</style>
	</head>
	<body>
		<div id="container"><br /><br /><br /><br /><br />Loading ...</div>
		<div id="info"></div>
		<!-- -->
		
		<script src="./lib/three.min.js"></script>
		<script src="./lib/stats.min.js"></script>
		<script src="./lib/vr.js"></script>
		<script src="./code/oculusIntegration.js"></script>
		<script src="./code/playerBullet.js"></script>
		<script src="./code/player.js"></script>
		<script src="./code/primitives.js"></script>
		<script src="./code/enemy.js"></script>
		<script src="http://js.leapmotion.com/0.3.0-beta3/leap.min.js"></script>
		<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
		<script src="./code/leapDriver.js"></script>
		<script>
			

			var container, stats;
			var camera, player, scene, renderer;
			var time = Date.now();
			var ray;
			var info;
			
			var angleYaw = 0;
			var anglePitch = 0;

			var cube;
			var skybox;
			var water;
			var levelMesh;
			
			var objArray = new Array();
			
			var restartLevelFlag;

			var fogLevel = 10;
			
			var level = [
				'--333444333--',
				'----------2--',
				'--2----------',
				'--2B-----22--',
				'---111-111---',
				'-----1P1-----'
			];

			var clock = new THREE.Clock();

			vr.load(function(error) {
				if (error) {
					alert('Plugin load failed: ' + error.toString());
				}

				init();
				logic();
				animate();
			});
			


			function init() {
				container = document.getElementById( 'container' );
				scene = new THREE.Scene();
				
				// fog effect is used for awesome fade in
				//scene.fog = new THREE.Fog(0xffffff, 50, 300);
				
				// create camera
				camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 7000 );			
				camera.rotation.order = 'XYZ';
				
				// create player character
				player = new PlayerCharacter(camera);
				scene.add(player.getObject());
				
				// loading code for things that can actually differ in levels
				loadLevel();
				
				// presumably, every level in this demo is going to have water, a skybox, and
				// purple highlights / yellow shadows
				water = createWaterPlane(scene);
				skybox = createSkybox(scene);
				
				var ambientLight = new THREE.AmbientLight( 0x400040 );
				scene.add( ambientLight );

				var dirLight = new THREE.DirectionalLight( 0xffeedd, 3 );
				dirLight.position.set( 1, 1, 0.5 ).normalize();
				scene.add( dirLight );

				// other universal things: webGL renderer, Oculus Rift effect, statistics
				renderer = new THREE.WebGLRenderer();
				renderer.setClearColor(0x6999AF, 1);
				container.innerHTML = "";
				container.appendChild( renderer.domElement );
				
				effect = new THREE.OculusRiftEffect(renderer);
				setTimeout(function(){ effect.setSize(window.innerWidth, window.innerHeight); }, 300);

				//stats = new Stats();
				//stats.domElement.style.position = 'absolute';
				//stats.domElement.style.top = '0px';
				//container.appendChild( stats.domElement );
				
				// we want to window to adapt to resizes ((like when we hit F11 in Firefox))
				window.addEventListener( 'resize', onWindowResize, false );
			}
			
			function loadLevel()	{
				levelMesh = createLevelMesh(level, camera, scene);
				
				fogLevel = 50;
				
				//scene.fog.near = 50;
				//scene.fog.far = 50;
			}
			
			
			function restartLevel()	{
				scene.remove(levelMesh);
				
				player.velocity.x = 0;
				player.velocity.y = 0;
				player.velocity.z = 0;
				player.canJump = false;
				player.moveForward = false;
				player.moveLeft = false;
				player.moveRight = false;
				
				restartLevelFlag = false;
				
				for (var i = 0; i < objArray.length; i++)	{
					if (typeof objArray[i].mesh != 'undefined')	{
						scene.remove(objArray[i].mesh);
					}
				}
				
				objArray = []; 
				
				loadLevel();
			}
			

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );
				effect.setSize(window.innerWidth, window.innerHeight);
			}

			var polled;
			var vrstate = new vr.State();
			
			function logic()	{
				if (restartLevelFlag) restartLevel();
				
				var start = (new Date).getTime();
				
				// poll VR, if it's ready
				polled = vr.pollState(vrstate);
				player.update( angleYaw, polled ? vrstate : null, levelMesh );
				
				player.moveForward = (forward > 0);
				player.moveLeft = (left > 0);
				player.moveRight = (right > 0);
				
				// the water has to update and look cool too
				water[0].offset.x += 0.005;
				water[0].offset.y += 0.005;
				
				if (fogLevel < 9000)	{
					fogLevel += 100;
					//scene.fog.far = fogLevel;
				} else	{
					//scene.fog.near = 100000;
					//scene.fog.far = 100000;
				}
				
				// update objects
				for (var i = 0; i < objArray.length; i++) {
					objArray[i].update();
				}
				
				// delete objects that need to be
				for (var i = objArray.length - 1; i > -1; i--) {
					if (typeof objArray[i].deleteFlag != 'undefined')	{
						if (objArray[i].deleteFlag)	{
							if (typeof objArray[i].mesh != 'undefined')	{
								scene.remove(objArray[i].mesh);
							}
					
							objArray.splice(i, 1);
						}
					}
				}

				//document.getElementById('info').innerHTML = "Leap Motion: " + " u: " + up + "  f: " + forward + "  l: " +
				//                                            left + "  r: " + right + "  m: " + mode;
				
				// logic should be running roughly independently of rendering
				var end = (new Date).getTime();
				var delta = end - start;
				var delay = 50.00 - delta;
				setTimeout(function(){logic()}, delay);
			}
			
			function animate() {
				vr.requestAnimationFrame(animate);
				
				effect.render(scene, camera, polled ? vrstate : null);
			}

		</script>

	</body>
</html>
